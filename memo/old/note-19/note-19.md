# Electronでつぶやきを保存する19

　一件あたりURLを5件までに制限した。

<!-- more -->

# ブツ

* [リポジトリ][]

[リポジトリ]:https://github.com/ytyaru/Electron.MyLog.20220923085800

## インストール＆実行

```sh
NAME='Electron.MyLog.20220923085800'
git clone https://github.com/ytyaru/$NAME
cd $NAME
npm install
npm start
```

# 情報源

* [Electron Chrome拡張機能サポート][]
* [mpurse][]
* [開発用拡張機能の読み込み (DevTools Extension, session)][]
* [CharlieAIO/extensions.js][]

[Electron Chrome拡張機能サポート]:https://www.electronjs.org/ja/docs/latest/api/extensions
[mpurse]:https://github.com/tadajam/mpurse
[開発用拡張機能の読み込み (DevTools Extension, session)]:https://zenn.dev/sprout2000/books/3691a679478de2/viewer/13449
[CharlieAIO/extensions.js]:https://gist.github.com/CharlieAIO/0fc4e3403d303301ae48e27088861493

# やったこと

　一件あたりURLを5件までに制限した。

　短縮URLにしたら140字以内でも10件くらい投稿できてしまうので。

## text-to-html.js

　テキストからURLらしき文字列の件数を返す。

```javascript
static countUrl(text) { // text内にあるURLの数を数える
    const regexp_url = /(([http|https|ipfs]?:\/\/[a-zA-Z0-9.\-_@:/~?%&;=+#',()*!]+))/g;
    return text.match(regexp_url).length
}
```

## mylog-db.js

　DBにinsertするときにURL数をチェックする。5つより多いとエラー。

```javascript
constructor() {
    this.URL_MAX_COUNT = 5
}
async insert(content, address=null) {
    if (this.URL_MAX_COUNT < TextToHtml.countUrl(content)) { throw new Error(`つぶやく内容に含めるURLは${this.URL_MAX_COUNT}つ以内にしてください。`) }
}
```

# URL数制限について

　基本的には140字制限のせいでたくさん書けない。URLがあればなおさら。でもURL短縮サービスを使うとたくさん書ける。つぶやきの範疇を超えてしまうので今回ように制限した。

　気になるのはURLの長さに上限がないこと。最悪URLをひとつも書けず投稿できないこともありうる。URL短縮サービスを使えば解決できるが外部サービスに依存してしまう。はたしてどうするべきか。色々考えると複雑なので別の記事にする。













# つぶやきの字とURLの上限数について考察

　つぶやき一件につき次のような制約をしている。

* 140字以内
* 15行以内
* 5URL以内

　ただ、URLについてよく調べると、もっとよい制限の仕方があるのではと思えた。そこであらためて文字数制限について考えてみた。

# 目的

* 簡潔につたえる
    * 投稿・読了しやすくする
* 省スペース
    * ファイルサイズ・通信データを減量する

# 方法

* 字＆URL数制限（少なくともA/Bいずれかひとつを満たすこと）
    * (A) 全テキスト140字以内である
    * (B) 非URL140字でありURL含め500字以内である。URLは5件まで。
* 警告表示
    * URL含め140字オーバー（ツイッター投稿できない旨を表示する）
    * URL含め500字オーバー（このアプリのDBに登録させない）
    * URLが5つより多い（このアプリのDBに登録させない）
* 短縮表示
    * スキーム省略する
    * ドメイン表示する（30字以内想定）
    * 30字以降を`…`にして短縮する

　今回の結論がこれ。理由がけっこう複雑。まずURLの長さには仕様上制限がない。それを許せばDBが膨大になるし表示もひどいことになる。そこでDB登録と表示にそれぞれ字数制限をかけることにした。また、既存SNSとの互換性がひと目でわかるよう字数オーバーしたときに警告表示する。上限値はおなじく既存SNSのそれを採用した。

　これをすべて実装するのはちょっと大変そう。

# 考察

## 字数

　制限数については次のように決定した。

* なるだけ既存SNSとの互換性を保つ
    * ツイッターは全テキスト140字以内である
    * マストドンは全テキスト500字以内である

　字数制限については基本140字以内であること。URLについてはできるだけ長いURLを受け付けることができるよう最大500字まで許容するようにした。

## URL数

　つぶやき一件につき、ひとつの物事について言及する想定。なのでURLもひとつが基本。でも何かを比較するときや前後の記事についてのURLが欲しいときもありそう。または将来の機能拡張でOGPの画像URLを追加することがあるかもしれない。そこで余裕をもたせURLの上限は5件までとした。

## なぜ140字＋αか

　ツイッターのようにURLも含めて140字制限にすると、URLの長さによって書けるテキストの長さが変わってしまう。それが不満なので変えたかった。

　つぶやく内容は自然言語によるテキストのはず。URLはあくまでオマケ。なのにそのオマケによって書けるテキストの長さを変えられてしまうことが嫌。なのでURLに限っては5件500字以内なら書けるようにした。

　これなら既存SNSとの互換性もある程度たもてる。もしURL含めて140字以内ならツイッターに投稿できるし、最大長500字になってもマストドンに投稿できる。それでいて、つぶやきの範疇を超えぬよう自然言語テキストは140字以内としている。

## なぜURLを短縮表示するか

　つぶやく内容のメインコンテンツは自然言語または画像や動画、音声であるはず。URLはあくまで参考文書や証拠などを指し示す識別子にすぎない。URLそれ自体をテキストとして見たいわけではない。しかもURLの長さは仕様上制限がないため長くなってしまう可能性がある。意味不明な英数字の羅列を長々とみせられてもウザいだけ。そこでURLは短縮表示することにした。

　さりとてフィッシング詐欺などにひっかかると困るのでドメイン名は表示する。それと概要がわかるかもしれないので末尾のファイル名も表示する。全部ふくめて30字くらいで収めるようにしたい。

## なぜ140,500字制限か

　いずれツイッターやマストドンにも投稿できるようにするかもしれない。そのとき上限内であるか否かすぐ判別できるようにしたい。そこで140や500といった字数を制限値として用いた。また、警告表示もそれとわかるようにする予定。

# 所感

　これを実装するとなると手間がかかる。ここに力をかけるより、140字15行5URL制限にしたほうが楽なのでは？　費用対効果てきにすごく残念な気がする。うん、そうだね、やめよう。せっかく色々調べて考えたけど、実装はしないでおこう。

　仮にURLが100字あったとしても残り40字で一言つぶやくことはできるはず。むしろ現代人にとっては40字ですら長文。もう現状でいいや。






　








# 文字数とURLについて

　制限する理由は投稿しやすくするため。

　でも、マジメに考えるとすごく面倒くさそうだとわかった。

## 短いは正義

　短いほうがすぐに読めて嬉しいし、書くほうも簡単。URLも同じ。

　URLは画像なら一瞬で読めるが、動画、音声、文書なら読むのに時間がかかる。つぶやき一件あたりひとつのURLでちょうどいいくらい。でも将来4枚の画像をまとめて４分割して表示する形式に対応することを考えて念のため5つにした。

　本当にURLを5つに制限するのでいいのか。よく考えてみると、どう制限すべきなのか難しいことが判明した。

## URLの長さ

　世の中にあるURLはどのくらい長いか。仕様として上限はあるのか。

* [URLの最大文字数って結局いくつなのさ～IE亡き後の新常識を探る][]

[URLの最大文字数って結局いくつなのさ～IE亡き後の新常識を探る]:https://qiita.com/pro_matuzaki/items/70fb639f7ed7463f9943

> IEが2083文字までしか利用できない

　どうやらIEのせいで2083字制限があったらしい。

> RFC上では8000文字までは対応できることが望ましい

> (そして相変わらず上限は設けられてない）

　仕様としては上限がないらしい。なんて恐ろしい話だ。

　実際にそんな長いURLがあるかというと見たことがない。StackOverflowの投稿で質問文がそのままURLの一部になるので、めちゃ長いのは見たことある。

　いずれにせよ140字制限がある場合、URLさえ書ききれないことも十分ありうる。

# 140字制限とのかねあい

* URL短縮サービスを使う
* URLを字数制限から除外する設計にする

### A. URL短縮サービス

　140字の中にURLを含めるとすぐにオーバーしてしまう。ツイッターもそのせいでURL短縮サービスがあるほど。でも、わざわざ外部サービスで短縮URLをエンコード／デコードすること自体に疑問がある。ムダにリクエスト数が増えてクライアントやサーバに負荷がかかりバカらしい。

　URLの長さは青天井なので長いURLに対しては有効なのだろう。でも普段そんな長いURLなんてないはずだし。

### B. URLを字数制限から除外する

　だったらURLは文字数制限から除外すればいいのでは？　つぶやき一件あたりのURL数は制限し、URL以外の文字列は140字以内とするとか。

　でも、もし将来ツイッターと連携することになったら困る。ツイッターはURL含めて140字以内が必須条件だから。なら、それはそれで警告表示することにすればいいかもしれない。URL含めて140字制限超過したときはツイッターで投稿できないマークを表示するとかして。

　となると字数制限は２パターンになる。

* URL文字を含めて140字超過した（ツイッター非互換警告表示）
* URL文字を抜いて140字超過した（このツールで登録できないエラー）

　あるいはURL制限をおもいきって1つにしてしまう。

* URLを文字数制限に含める
* URLを文字数制限に含めず別途URL数制限し文字数からURL字数を抜く

　そもそも複数のURLがほしいときはどんなときか。

URL数|用途
-----|----
1|紹介や報告など
2|比較など
3|記事の今,前,後など
4|画像4分割など

　つぶやき一件あたり何かひとつに対して言及するもの。ならURLもひとつで十分のはず。

　箇条書きや一覧のときはURLがもっと多くなる。けどそれはもう、つぶやきや一言ではなくなってしまう。MastodonやMisskeyなら500字以上なので可能かもしれないが。今回はもっと一つの事柄だけにフォーカスを当てた投稿を想定している。

　となると「URL一件だけ＆文字数からURL字数を抜く」パターンでよいかな？

　ただしURL含めて140字以内であればURL数は制限しない。これなら短縮サービスを使わずとも2件くらいは書けそう。つぶやきとして丁度よい量のような気がする。

# URLを文字数制限から外して困ることは？

　URLに字数制限がないなら無限に書いてDBにゴミデータを書き込めてしまう。

　というわけでURLには適当に字数制限をかけよう。

* URL文字列長2000以内（IEの2083字上限参考）
* 全テキストあわせて500字以内（Mastodonの上限値参考）

　全500字以内を採用しよう。このとき最大長テキストを登録するに非URL140字＋URL360字＝500字となる。非URLをなくせばURLだけで500字かける。

# URLを短く表示すべきでは？

　つぶやき一件あたり非URL140字＋URL360字＝500字とすると、本文よりURLのほうが長くなってしまう。意味不明な英字の羅列などみたくない。

　それを解決する方法としてURLの代わりにテキストを表示する案がある。でもそれはMarkdownやHTMLで実装することになる。複雑化するので避けたい。

　単にURL文字列を全文表示するのではなく、短縮表示したらどうか。末尾を`...`にするとか。

```html
<a href="全URL">https://domain/...</a>
```

　スキームは大体`https://`だろうから省略してもいいとして。ドメイン名くらいまでは表示したい。フィッシング詐欺サイトかどうか判断するためにも。

　もっとも、ふつうブラウザではリンクにマウスポインタを当てると下部にURLが表示される。最悪、右クリックでURL文字列をコピーしてテキストエリアに貼り付ければよい。

　スマホだと困るかもしれない。でも小さい画面で長いURLなんてどうせ全文みたりしない。

　というわけで、適当に制限する。もしURLが30字以上なら以降を`…`で短縮表示する。これでテキスト本文を邪魔せず、ドメイン名も見えるはず。

# まとめ

　つぶやきとして保存・表示するとき字数制限を課すことで適切化する。

* DB容量を制限する
* 目に入る無益な字数を省く

　具体的にはつぎのようなことをする。

* 字＆URL数制限（少なくともA/Bいずれかひとつを満たすこと）
    * (A) 140字数制限にURL文字長を含める
        * URL数制限なし
    * (B) 140字数制限からURL文字長を除外する
        * URLはひとつのみ含められる
        * URLを含め500字以内である
* 警告表示
    * URL含め140字オーバー（ツイッター投稿できない旨を表示する）
    * URL含め500字オーバー（このアプリのDBに登録させない）
    * URLが5つより多い（このアプリのDBに登録させない）
* 短縮表示
    * スキーム省略する
    * ドメイン表示する（30字以内想定）
    * 30字以降を`…`にして短縮する

　字数制限については別の書き方をすると以下。

* (A) 全テキストが140字以内である
* (B) 非URLが140字以内であり、かつURLを含めた全テキストが500字以内である

　これでいい感じになる。

　これをすべて実装するとなると、ものすごく大変そう。なので今回は単にURLを5つ以内に制限するだけにした。

